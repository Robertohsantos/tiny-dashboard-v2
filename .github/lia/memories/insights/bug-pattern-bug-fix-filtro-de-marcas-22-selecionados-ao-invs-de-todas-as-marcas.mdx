---
id: >-
  bug-pattern-bug-fix-filtro-de-marcas-22-selecionados-ao-invs-de-todas-as-marcas
type: bug_pattern
confidence: 0.95
created_at: '2025-09-24T07:50:59.490Z'
updated_at: '2025-09-24T07:50:59.490Z'
tags:
  - produtos
  - filtros
  - bug-fix
  - ui-consistency
  - marcas
  - initialized-state
source: user_input
project_root: /home/roberto/tiny-dashboard
relationships: []
---

# Bug Fix: Filtro de Marcas "22 selecionados"

## üêõ Problema

- Filtro de marcas iniciava com "22 selecionados" ao inv√©s de "Todas as marcas"
- Comportamento inconsistente com outros filtros (dep√≥sito e fornecedor)
- S√≠mbolo de filtro ativo e bot√£o "limpar filtros" sempre vis√≠veis
- Contradi√ß√£o com a documenta√ß√£o que define "arrays vazios = todos selecionados"

## üîç Causa Raiz

1. **Inicializa√ß√£o incorreta** em `src/app/produtos/page.tsx` (linhas 39-43)

   - Arrays sendo inicializados com todos os IDs espec√≠ficos
   - `marca: allMarcaSlugs` continha 22 marcas espec√≠ficas

2. **Fun√ß√£o `isAllSelected` n√£o tratava arrays vazios** em `src/modules/produtos/utils/produtos-transforms.utils.ts`
   - S√≥ considerava "todos selecionados" quando `count === totalItems`
   - N√£o tratava `count === 0` como "todos selecionados"

## üõ†Ô∏è Solu√ß√µes Implementadas

### 1. Corre√ß√£o da Inicializa√ß√£o

**Arquivo:** `src/app/produtos/page.tsx`

```ts
// ‚ùå ANTES (incorreto)
initialFilters={{
  deposito: allDepositos,     // Array com IDs espec√≠ficos
  marca: allMarcaSlugs,       // Array com 22 marcas espec√≠ficas
  fornecedor: allFornecedores, // Array com IDs espec√≠ficos
}}

// ‚úÖ DEPOIS (correto)
initialFilters={{
  deposito: [],    // Array vazio = "todos selecionados"
  marca: [],       // Array vazio = "todos selecionados"
  fornecedor: [],  // Array vazio = "todos selecionados"
}}
```

### 2. Corre√ß√£o da Fun√ß√£o isAllSelected

**Arquivo:** `src/modules/produtos/utils/produtos-transforms.utils.ts`

```ts
// ‚úÖ Adicionado suporte a arrays vazios em todos os casos
case FilterType.DEPOSITO:
  return count === 0 || (FILTER_TOTALS.DEPOSITOS > 0 && count === FILTER_TOTALS.DEPOSITOS)

case FilterType.FORNECEDOR:
  return count === 0 || (FILTER_TOTALS.FORNECEDORES > 0 && count === FILTER_TOTALS.FORNECEDORES)

case FilterType.MARCA:
  if (typeof totalItems !== 'number' || totalItems === 0) {
    return count === 0
  }
  return count === 0 || count === totalItems
```

## ‚úÖ Resultado

- **Consist√™ncia visual:** Todos os filtros mostram "Todos os..." ao inicializar
- **Comportamento correto:** S√≠mbolos e bot√µes aparecem apenas quando necess√°rio
- **Logs confirmam:** `filter recebido: undefined` (sem filtros aplicados)
- **Conformidade:** Alinhamento total com a documenta√ß√£o estabelecida

## üìã Checklist de Valida√ß√£o

- [x] Filtros inicializam com texto correto ("Todas as marcas")
- [x] Consist√™ncia entre dep√≥sito, marca e fornecedor
- [x] S√≠mbolo de filtro ativo oculto quando n√£o h√° filtros
- [x] Bot√£o "limpar filtros" oculto quando n√£o h√° filtros
- [x] Funcionalidade de filtragem mantida para sele√ß√µes espec√≠ficas
- [x] Logs mostram `filter: undefined` corretamente

## üîó Arquivos de Refer√™ncia

- Documenta√ß√£o: `docs/produtos-filter-logic.md` (se√ß√£o 3.2, item 3)
- Contexto: `src/modules/produtos/contexts/filter-context.tsx` (fun√ß√£o `isFilterActive`)
- Constantes: `src/modules/produtos/constants/produtos-filters.constants.ts`
